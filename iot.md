# 1 IoT功能设计

用于IoT管理企业的授权、设备库等模块的管理。可配置企业授权码（但不可明文显示），如果物联网关与IoT在企业授权码上保持一致，方可进行数据通信。

作者 | 版本号 | 日期 | 变更内容
:-- | :-- | :-- | :--
张程 | 1.0.6 | 2021-01-13 | -
张程 | 1.0.5 | 2021-01-12 | a) 设备库/资产库及其下级目录添加表格层级展示<br /> b) 电气设备：设备库 - 设置服务，资产库 - 调用服务
张程 | 1.0.4 | 2021-01-11 | a) 1.4.1.1 物联网关组织机构（新增）<br /> b) 1.4.1.2 物联网关基础属性（调整）<br /> c) 1.4.1.3 物联网关配置模板（调整）
张程 | 1.0.3 | 2021-01-09 | a. 设备库调整<br /> b. 资产库调整<br /> c. 用能检测
张程 | 1.0.0 | 2020-12-27 | - 

## 1.1 Dashboard

展示企业系统界面统计信息：
1. 企业基础属性。
2. 设备的存活率和在线状态。
3. 时段统计曲线图统计（报警、冻结数据等）。
4. 重要事件列表。
5. ...

## 1.2 企业管理

数据库设计表：

+ 《企业表》

每个企业生成唯一的授权码productKey。按照授权productKey、有效时间允许企业的物联网关接入IoT，可以限制接入设备的数量等。

### 1.2.1 基础属性

属性 | 英文 | 描述
:-- | :-- | :--
企业名称 | name | 必须
授权码 | productKey | 必须
智联网关 | gateway | 数量
电气设备 | device | 数量
传感器 | sensor | 数量
联系方式 | phone
其他 | - | 生效时间、管理账号人数、logo、email、联系方式等。
状态 | status | 在用/停用

### 1.2.2 功能

+ 增删改查：对企业进行增删改查操作。
+ 启用/停用：对企业进行启动/停用操作。
+ 绑定账号：对企业进行绑定管理员账号操作，用于企业的相关操作。

## 1.3 设备库

操作流程：

1. 新增传感器
2. 录入指令
3. 录入点位，点位关联命令字
4. 保存为传感器物模型
5. 新增电气设备
6. 绑定传感器
7. 选定指令
8. 保存为电气设备物模型

数据库设计表：

+ 1.3.1《电气设备表》
+ 1.3.2《传感器表》
+ 1.3.3《命令表》
+ 1.3.4《点位表》
+ 1.3.5《传感器点位全量关联表》
+ 1.3.6《电气设备关联传感器点位表》
+ 《电气设备事件表》（暂无）
+ 《电气设备服务表》（暂无）

在IoT平台中创建的传感器与电气设备的物模型，用于定义平台与盒子支持的传感器、电气设备类别。

类编码命名规则: S_XXX_id (类型编码_md5(id, key))，详情查看[1.3.3 标别码]

### 1.3.1 传感器物模型

二次数据。点位和命令做全量配置。

#### 1.3.1.1 基础属性

+ 类编码(S_XXX_id)。
+ 类型、名称、型号、厂商、描述。（固有属性）
+ 通信协议、设备描述符、设备地址、波特率、数据位、停止位、奇偶校验、采集周期。（配置属性）

属性 | 英文 | 描述
:-- | :-- | :--
类编码 | sensorCatId | 必须
类型
名称
型号
厂商
描述
配置属性 | configurable | 通信协议、设备描述符、设备地址、波特率、数据位、停止位、奇偶校验、采集周期
状态 | status | 通过/未通过/失败

```
{
  "sensorCatId":"传感器类编码",
  "profile": {
    "permanent": {
      "type": "类型",
      "name": "名称",
      "version": "型号",
      "producer": "厂家",
      "description": "描述"
    },
    "configurable": {
      "protocol": "DL/T645-2007", // 通信协议
      "device": "/dev/ttyS1", // 设备描述符
      "address": "0x51612000", // 设备地址
      "bps": 9600, // 波特率
      "ndata": 8, // 数据位
      "nstop": 1, // 停止位
      "parity": "E", // 奇偶校验
      "gather": 15 // 采集周期
    }
  },
  "timestamp":1510292697470
}
```

#### 1.3.1.2 命令

做全量配置。

命令与通信协议有关，根据通信协议的不同，命令也有着不同的类型和定义，即通信协议决定命令。
命令字以字符串的形式进行传输和存储，若以 0x 开头则认定为 16 进制数，若不以 0x 开头则认定为 10 进制数。

> **命令类型与点位类型**
> 命令类型> 描述了解析命令裸数据的类型，当收到命令数据响应后，根据命令类型对裸数据进行解析。
> 点位类型> 描述了点位的数据类型，是> 面向输出的类型> ，并不会根据通信协议的不同而变化。
命令类型根据协议而定义，会根据协议有所不同，因此需要对其做进一步的类型转换，即点位类型。

目前支持的通信协议类型：

| **通信协议类型** | **描述** |
| :---: | :---: |
| DL/T645-1997 | DL/T645-1997 多功能电能表规约 |
| DL/T645-2007 | DL/T645-1997 多功能电能表规约 |
| ModbusRTU | Modbus 串口通信 |
| IEC60870-5-103 | IEC60870-5-103 规约 |

单独建表

属性 | 英文 | 描述
:--|:--|:--
传感器类编码 | sensorCatId
命令 | word
描述 | value | { "word": "命令字", "length": 1, "type": "命令类型" }

```
{
  "sensorCatId":"传感器类编码",
  "commands": {
    "0x02010100": {
      "word": "0x02010100",
      "type": "float"
    }
  },
  "timestamp":1510292697470
}
```

#### 1.3.1.3 点位

做全量配置。

传感器点位需要绑定命令时，根据命令类型的不同，绑定的方法稍有不同，即点位 `ref` 字段所指示的内容。
程序将根据命令类型对裸数据进行解析，解析后转换成对应的统一的解析类型供进一步处理。

| **命令类型** | **绑定方法** | **内容示例** | **点位类型** |
| :---: | :---: | :---: | :---: |
| uint16 | 命令字 | 0x02010100 | int |
| float | 命令字 | 0x02010100 | float |
| bit | 命令字/索引 | 0x02010100/1 | int |
| floats | 命令字/索引 | 0x02010100/3 | float |
| time | 命令字 | 0x02010100 | timestamp |
| float+time | 命令字 | 0x02010100 | float |
| - | 命令字/time | 0x02010100/time | timestamp |

关联表

属性 | 英文 | 描述
:--|:--|:--
传感器类编码 | sensorCatId
点位名 | word
描述 | value

```
{
  "sensorCatId":"传感器类编码",
  "properties": {
    "PhV_phsA": {
      "id": "PhV_phsA", // 点位名
      "name": "A相电压", // 点位描述
      "type": "float", // 点位类型
      //"rate": 1.0, // 系数
      "ref": "0x02010100" // 关联命令
    },
    "lastTime":1510292697470
  }
},
"timestamp":1510292697470
}
```

### 1.3.2 电气设备物模型

一次数据。最后一项为版本号，从001累加。以适应同种电气设备实现不同的业务场景。

#### 1.3.2.1 基础属性

+ 类编码(D_XXX_001_id (类型编码_md5(id, key)_版本号))。
+ 类型、名称、型号、厂商、描述。（固有属性）

属性 | 英文 | 描述
:-- | :-- | :--
类编码 | deviceCatId | 必须
类型
名称
型号
厂商
描述

```
{
  "deviceCatId":"电气设备类编码",
  "profile": {
    "permanent": {
      "type": "类型",
      "name": "名称",
      "version": "型号",
      "producer": "厂家",
      "description": "描述"
    }
  },
  "timestamp":1510292697470
}
```

#### 1.3.2.2 关联传感器

属性 | 英文 | 描述
:-- | :-- | :--
电气设备类编码 | deviceCatId
传感器类编码 | sensorCatId

关联特定类型特定型号特定软件版本的传感器，获取传感器类编码sensorCatId

```
{
  "deviceCatId":"电气设备类编码",
  "sensors":[
    {
      "sensorCatId":"传感器类编码"
    }
  ],
  "timestamp":1510799670074
}
```

#### 1.3.2.3 点位

全量更新。

关联传感器后，可以自由选择其属性，进行灵活配置规则，得出需要的一次数据。 

属性 | 英文 | 描述
:-- | :-- | :--
电气设备类编码 | deviceCatId
传感器类编码 | sensorCatId
点位id

```
{
  "deviceCatId": "电气设备类编码",
  "properties": { // 点位
    "PhV_phsA": {
      //"id": "PhV_phsA", // 点位名
      "name": "A相电压", // 点位描述
      "ref": "$sensorCatId/$property", // 关联传感器类编码点位
      "type": "float" // 点位类型
    }
  },
  //"events": {}, // 事件
  //"services": {}, // 服务
  "timestamp": 1510292697470
}
```

#### 1.3.2.4 事件

需进一步讨论来明确，待补充

<s>基于关联后的传感器基础属性，进行灵活配置规则，得出需要的事件。

1. 遥信（判定规则三级）signal (普通[ordinary]/警告[warn]/紧急[urgent])
2. 遥测（传感器事件）telemetry
3. 网关状态、传感器异常 gateway

事件编码在IoT定义一张独立的表，保证事件eventId的唯一性</s>

#### 1.3.2.5 服务

需进一步讨论来明确，待补充

### 1.3.3 编码

#### 1.3.3.1 类型

**电气设备**

编码 | 名称 | 类型
:--|:--|:--
01 | 电表 | ammeter
02 | 高压柜 | highVoltage
03 | 低压柜 | lowVoltage
04 | 干式变压器 | transformer
05 | 无功补偿装置 | svg

**传感器**

编码 | 名称 | 类型
:--|:--|:--
01 | 电能表 | ammeter
02 | 温度传感器 | temperature
03 | 湿度传感器 | humidity
04 | GPS | gps
05 | 综保 | insurance
06 | 变压器温显 | transformer
07 | 有载调压控制器 | Loaded
08 | 数显表 | amc
09 | 无功补偿控制器 | recoup

#### 1.3.3.2 字典定义

属性 | 英文 | 描述
:--|:--|:--
分组 | group
类型 | type
名称 | name
编码 | code
描述 | description

## 1.4 资产库

数据库设计表：

+ 《物联网关表》
+ 《配置模板表》
+ 《电气设备表》
+ 《传感器表》

物联网关作为接入IoT最小单元，以CPU id作为唯一标识gatewayCode，与设备gatewaySecret、企业授权码productKey一起配置到物联网关。双重认证通过后，通过MQTT接入IoT。

### 1.4.1 物联网关

向上绑定节点关联组织机构，向下配置模板关联电气设备和传感器。  
可以绑定 组织机构（变电站 - 线路 - 撬电等），并进行筛选。  
物联网关接入，未注册根据productKey导入相应企业的物联网关**临时资产库列表**。由企业级别管理员手动激活认证后添加到**资产库**。 
根据平台分配的gatewayId进行物联网关进行更换（此时IoT会更新gatewayCode，并将gatewaySecret重新反馈给物联网关）

针对物联网关来讲，物联网关本身的数据大致分为基础属性、配置属性、运行状态、运行数据和配置模板。

- 基础属性包括物联网关的序列号、生产批次、生产编号等；
- 配置属性包括物联网关的企业授权码、网络配置信息等。
- 运行状态包括物联网关的位置信息、操作系统状态信息等；
- 配置模板主要是讲物联网关所对应的物模型的配置模板；
- 运行数据主要是根据配置模板进行数据采集和处理后输出至 IoT 平台的数据；

物联网关本身的数据同步方式如下：

- 基础属性的更新、配置模板的获取与更新，在物联网关的交互界面上，由人工进行触发；
- 运行数据根据配置模板中定义的通信周期进行上传；
- 运行状态根据需求进行低频的上传；
- 配置属性仅仅在物联网关本地进行配置，即通过物联网关网页客户端进行修改。

| 属性 | 英文 | 描述 |
| :---: | :---: | :---: |
| IoT编码 | gatewayId
| IoT密码 |  gatewaySecret
| 序列号 | sn | CPU 序列号，作为MQTT Client ID |
| 名称 | name
| 厂家
| 型号
| 经度
| 纬度
| 企业Id
| 撬变Id
| 固有属性 | permanent
| 配置属性 | configurable
| 技术属性 | technical
| 扩展属性 | extended
| 状态 | status

####  1.4.1.1 组织机构

对接入的物联网关进行组织机构绑定。

#### 1.4.1.2 基础属性

- 固有属性[permanent]（object）
- 配置属性[configurable]（object）
- 技术属性[technical]（object）
- 扩展属性[extended]（object）

```
{
  "gatewayId": "物联网关id",
  "name": "物联网关名称",
  "profile": {
    "permanent": {
      "sn": "物联网关序列号",
      "version": "物联网关型号",
      "name": "物联网关名称",
      "address": "安装地址",
      "longitude": "经度",
      "latitude": "纬度",
      "OS": {
        "version": "物联网关OS版本号",
        "timestamp": "物联网关OS版本发布时间"
      },
      "software": [
        {
          "version": "软件子版本号-1",
          "timestamp": "软件子版本发布时间-1"
        },
        {
          "version": "软件子版本号-2",
          "timestamp": "软件子版本发布时间-2"
        }
      ],
      "openTime": "物联网关开机时间",
      "createTime": "物联网关运行时间",
      "hardware": {
        "version": "硬件版本号",
        "timestamp": "硬件版本发布时间"
      },
      "resetTime": "物联网关重启时间",
      "normalTime": "物联网关正常运行时间",
      "lastTime": "最后修改时间戳（ms）"
    },
    "configurable": {
      "productKey": "企业授权码",
      "gatewayId": "IoT唯一id（物联网关）",
      "gatewaySecret": "******",
      "broker": {
        "ip": "127.0.0.1",
        "port": "8080"
      },
      "show": 1, // 位置是否显示
      "lastTime": "最后修改时间戳（ms）"
    },
    "technical": {
      "port485": {
        "1": {
          "id": "485口-1",
          "sensor": {} #, 485口-1 绑定的传感器信息
        },
        "2": {
          "id": 2,
          "sensor": {} #, 485口-2 绑定的传感器信息
        },
        "3": {
          "id": 3,
          "sensor": {} #, 485口-3 绑定的传感器信息
        },
        "4": {
          "id": 4,
          "sensor": {} #, 485口-4 绑定的传感器信息
        },
        "5": {
          "id": 5,
          "sensor": {} #, 485口-5 绑定的传感器信息
        },
        "6": {
          "id": 6,
          "sensor": {} #, 485口-6 绑定的传感器信息
        },
        "7": {
          "id": 7,
          "sensor": {} #, 485口-7 绑定的传感器信息
        },
        "8": {
          "id": 8,
          "sensor": {} #, 485口-8 绑定的传感器信息
        }
      },
      "lastTime": "最后修改时间戳（ms）"
    }
  },
  "timestamp": 1510292697470
}
```


#### 1.4.1.3 配置模板

物联网关层面，集合几种电气设备，为特定场景设定特定物模型。由企业管理员创建，方便运维人员下载使用，进行现场部署实施，做全量更新。

```sequence
title: 配置模板流程
participant 管理员
participant IoT平台
participant 物联网关

物联网关->IoT平台: 请求下载模板
IoT平台-->>物联网关: 无模板
IoT平台-->>IoT平台: 管理员，需要创建模板
管理员->管理员: 创建模板一
管理员->IoT平台: 选择设备库中电气设备
IoT平台-->IoT平台: 资产库自动添加
IoT平台-->>管理员: 返回电气设备和传感器
管理员->IoT平台: 提交编辑基础属性
IoT平台-->>IoT平台: 生成新版本的模板（模板一+时间戳）
IoT平台-->>管理员: 已生效
物联网关->IoT平台: 请求下载模板
IoT平台-->>物联网关: 组装 配置模板 （模板一、组织结构、基础属性）
物联网关->IoT平台: 修改基础属性
IoT平台-->>IoT平台: 基础属性更新
```

属性 | 英文 | 描述
:--|:--|:--
物联网关id | gatewayId
名称 | name
版本 | version
描述 | | json
创建时间 | createTime

双方同步电气设备和传感器，做新增处理。配置模板格式如下：

```
{
    "gatewayId": "IoT平台物联网关唯一标识",
    "id": "模板id",
    "version": "1.0.0", // 模板版本号
    "profile": {...}, // 基础属性
    "organization": {...}, // 组织机构
    "sensors": [...], // 传感器物模型集合
    "devices": [...], // 电气设备物模型集合
    "createTime": 182322323233 // 创建时间戳
}
```

#### 1.4.1.4 关联子设备

##### 1.4.1.4.1 电气设备

一表一值

**基础属性**

+ `permanent`: 固有属性
+ `configurable`: 配置属性（可配置属性）
 + `gateway`: 针对物联网关
+ `technical`: 技术台账
+ `extended`: 扩展属性

固有属性

所有电气设备在第一次录入时，将此模块的属性固定化，后期不会更改的。考虑可以直接从物联网关上报，减少录入成本。

```
{
  "deviceId":"IoT唯一编号",
  "profile": {
    "permanent":{
      "id": "123", #本地唯一编号
      "type": "highVoltage", #电气设备类型
      "name": "高压进线开关柜", #电气设备名称
      "version": "X型", #电气设备型号
      "producer": "深圳市科陆电子科技股份有限公司", #电气设备厂家
      "code": "sns123456", #出厂编号
      "date": "2020年10月16日", #生产日期
      "voltage": "100V" #电压等级 (V)
    }
  },
  "timestamp":1510292697470
}
```
配置属性（物联网关相关）

物联网关ID-电气设备ID-传感器ID一起定位在物联网关内的电气设备，由IoT录入。

```
{
  "deviceId":"IoT唯一编号",
  "profile": {
    "configurable":{
      "gateway": {
        "IpDate": "2020年12月17日", #投运日期
        "initTime": "00:00:00", #初始通信时间
        "frequency": 15, #通信频率（s）
        "position": "安装位置" #安装位置
      }
    }
  },
  "timestamp":1510292697470
}
```

技术台账

以基于电能表的电气设备为例，针对不同的电能表，所填信息不同。考虑可以直接从物联网关上报，减少录入成本。

```
{
  "deviceId":"IoT唯一编号",
  "profile": {
    "technical":{
      "Un": {
        "calculation": {
          "input": [3, 57.7, 100],
          "formula": "${a}*${b}/${c}"
        },
        "unit":"V"
      }, #参比电压 3×57.7/100V
      "Ib":{
        "val":1.5,
        "unit":"A"
      }, #基本电流
      "In": {
        "val":1.5,
        "unit":"A"
      }, #额定电流
      "Imax": {
        "val":6,
        "unit":"A"
      }, #最大电流
      "cycle": "4年", #检验周期
      "active": {
        "val":0.5,
        "unit":"S"
      }, #有功准确度等级
      "reactive": 1 #无功准确度等级
    }
  },
  "timestamp":1510292697470
}
```

扩展

上述不能满足时，在`extended`录入

```
{
  "deviceId":"IoT唯一编号",
  "profile": {
    "extended":{}
  },
  "timestamp":1510292697470
}
```

调用服务

+ 平台发起
+ 来自业务请求

属性由系统管理员配置，企业级别只需要绑定本版本支持的传感器即可调用。

##### 1.4.1.4.2 传感器

一表一值。

**基础属性**


+ 电流互感器变比、电压互感器变比、电压系数。（固有属性）
属性 | 英文 | 描述
:-- | :-- | :--
传感器id | sensorId | 必须
类型
名称
型号
厂商
电流互感器变比 | CT
电压互感器变比 | PT
电压系数 | V_rate
固有属性 | permanent
配置属性 | configurable
技术台账 | technical
扩展属性 | extended
状态 | status | 通过/未通过/失败

+ `permanent`: 固有属性
+ `configurable`: 配置属性（可配置属性）
 + `gateway`: 针对物联网关
 + `device`: 针对电气设备
+ `technical`: 技术台账
+ `extended`: 扩展属性

固有属性

所有传感器在第一次录入时，将此模块的属性固定化，后期不会更改的。考虑可以直接从物联网关上报，减少录入成本。

```
{
  "sensorId":"IoT唯一编号",
  "profile": {
    "permanent":{
      "id": "123", #本地唯一编号
      "type": "ammeter", #传感器类型
      "name": "电子式多功能电能表", #传感器名称
      "version": "DTZ716型", #传感器型号
      "producer": "深圳市科陆电子科技股份有限公司", #传感器厂家
      "code": "sn123456", #出厂编号
      "date": "2020年12月16日", #生产日期
      "voltage": "100V", #电压等级 (V)
      "protocol": "DLT645-07表/DLT645-97表" #通信协议
    }
  },
  "timestamp":1510292697470
}
```

配置属性（电气设备相关）

针对传感器对应不同的电气设备，不同的物理位置，换位等情况，存在多次配置，由IoT录入。

```
{
  "sensorId":"IoT唯一编号",
  "profile": {
    "configurable":{
      "device": {
        "channel": 1, #通道号
        "address": "1", #传感器通讯地址
        "position": "G1高压带计量柜", #安装位置
        "type": "RS485", #通信类型
        "rate": 9600, #波特率
        "dataBits": "数据位", #数据位
        "checkDigit": "校验位", #校验位
        "stopBit": "停止位", #停止位
        #"frequency": "通信频率（s）",
        "gather": 1 #采集频率（s）
      }
    }
  },
  "timestamp":1510292697470
}
```

配置属性（物联网关相关）

物联网关ID-电气设备ID-传感器ID一起定位在物联网关内的传感器，由IoT录入。

```
{
  "sensorId":"IoT唯一编号",
  "profile": {
    "configurable":{
      "gateway": {
        "IpDate": "2020年12月17日", #上一次校验日期
        "ET": {
          "calculation": {
            "input": [75, 5],
            "formula": "${a}/${b}"
          }
        }, #电流互感器变比 75/5=15
        "VT": {
          "calculation": {
            "input": [35000, 100],
            "formula": "${a}/${b}"
          }
        }, #电压互感器变比 35000/100=350
        "magnification": 5250, #倍率值
        "VCR": {
          "calculation": {
            "input": [3, 1/2, 1000],
            "formula": "Math.pow(${a}, ${b})/${c}"
          }
        }, #电压系数 √3*/1000=0.001732
        "date": "每月25日00:00:00", #抄表例日
      }
    }
  },
  "timestamp":1510292697470
}
```

技术台账

以电能表为例，针对不同的电能表，所填信息不同。考虑可以直接从物联网关上报，减少录入成本。

```
{
  "sensorId":"IoT唯一编号",
  "profile": {
    "technical":{
      "Un": {
        "calculation": {
          "input": [3, 57.7, 100],
          "formula": "${a}*${b}/${c}"
        },
        "unit":"V"
      }, #参比电压 3×57.7/100V
      "Ib":{
        "val":1.5,
        "unit":"A"
      }, #基本电流
      "In": {
        "val":1.5,
        "unit":"A"
      }, #额定电流
      "Imax": {
        "val":6,
        "unit":"A"
      }, #最大电流
      "cycle": "4年", #检验周期
      "active": {
        "val":0.5,
        "unit":"S"
      }, #有功准确度等级
      "reactive": 1 #无功准确度等级
    }
  },
  "timestamp":1510292697470
}
```

扩展

上述不能满足时，在`extended`录入

```
{
  "sensorId":"IoT唯一编号",
  "profile": {
    "extended":{}
  },
  "timestamp":1510292697470
}
```

#### 1.4.1.3 运行状态

| **状态名称** | **数据来源** | **说明** |
| :---: | :---: | :---: |
| 位置信息 | 物联网关 | 平台纠偏；默认坐标系 |
| CPU使用情况 | 物联网关 |  |
| 内存使用情况 | 物联网关 |  |
| 磁盘使用情况 | 物联网关 |  |
| 时间来源 | 物联网关 | NTP/GPS/手动填写 |
| 时间数据 | 物联网关 | 瞬时 |
| 开机时间 | 物联网关 |  |
| 运行时长 | 物联网关 | 操作系统 |
| 连接状态 | 物联网关 | 是否在线（与 IoT 平台连接） |
| 激活状态 | 物联网关 |  |
| 4G信号强弱 | 物联网关 |  |
| 4G的 IP 地址 | 物联网关 | 运营商分配 |
| 全额数据量 | IoT 平台 | 平台统计 |

+ 盒子状态
    + 空闲状态
    + 运行状态
+ 授权码
  + 未授权
    + 未激活
    + 授权码不存在
  + 已授权

#### 1.4.1.4 运行数据

最新一条电气设备的运行数据。

## 1.5 系统设置

数据库设计表：

+ 《字典表》
+ 《用户表》
+ 《权限表》
+ 《角色表》
+ 《用户角色表》
+ 《角色权限表》
+ 《组织机构表》

不同的成员可以有不同的权限。 

用户成员类型分为管理员和普通成员,管理员拥有所有权限，其他成员只能管理分配给自己的权限。

若在组织机构上指定权限和绑定用户，则绑定的用户只有本节点下的指定权限。

### 1.5.1 权限管理

属性 | 英文 | 描述
:--|:--|:--
标识
父id
名称
类型 | type | button/menu
描述
状态
所属企业 | - | 自动匹配

![图片](./img/ph007.png)

权限定位到button上

![图片](./img/ph008.png)

### 1.5.2 角色管理

属性 | 英文 | 描述
:--|:--|:--
标识
名称
描述
所属企业 | - | 自动匹配

![图片](./img/ph019.png)

### 1.5.3 组织机构

撬变的载体叫平台

自由设置企业的树形组织机构。例如：变电站--线路--撬变

属性 | 英文 | 描述
:--|:--|:--
父id
类型
名称
电压等级
协议容量
经度
纬度
平台类型 | | 钻井/压裂/生产
基础属性（固有属性）
基础属性（配置属性）
基础属性（技术属性）
基础属性（扩展属性）
状态

```json
{
  "type": "station",
  "id": "变电站id",
  "name": "变电站名称，eg. 35kV玄滩变电站",
  "voltageLevel": "电压等级（kV）",
  "capacity": "协议容量（kVA）",
  "child": {
    "type": "line",
    "id": "线路id",
    "name": "线路名称，eg. 35kV玄昆线",
    "profile": {
      "permanent": {
        "conductorModel": "导线型号",
        "lineLength": "线路长度（km）"
      }
    },
    "child": {
      "type": "group",
      "id": "橇变id",
      "name": "橇变名称，eg. 泸203H6-1（2）",
      "voltageLevel": "电压等级（kV）",
      "capacity": "主变容量（kVA） eg. 3150kVA",
      "profile": {
        "permanent": {
          "producer": "橇变厂家",
          "type": "橇变型号",
          "code": "出厂编号 eg. NO.123456",
          "model": "出厂日期 2020/8/23",
          "size": "橇变尺寸 eg. 1000*200*100",
          "weight": "橇变重量 eg. 25t",
          "protectionLevel": "防护等级 eg. IP3X"
        },
        "configurable": {
          "platform": "所属平台 eg. 泸203H6",
          "team": "井队名称 eg. 中石化中原石油工程有限公司西南钻井分公司70167ZY",
          "type": "开采设备型号 eg. 70D/70DB/7000型",
          "assembler": "安装单位 eg. 四川卓网智慧能源有限公司",
          "operator": "运维单位 eg. 泸县项目部",
          "operatorGroup": "运维班组 eg. 检修班组",
          "commissioningDate": "投运日期 eg. 2020/10/23",
          "platformCategory": "平台类别 eg. 钻井/压裂/生产",
          "productStage": "生产阶段 eg. 钻井1开2开3开4开/压裂2段3段/"
        }
      }
    }
  },
  "lastTime": "最后修改时间戳（ms）"
}
```

![图片](./img/ph009.png)

若在组织机构上指定权限和绑定用户，则绑定的用户只有本节点下的指定权限。

![图片](./img/ph018.png)

![图片](./img/ph020.png)

### 1.5.4 用户管理

添加管理账号，用于管理设置系统的各种权限。

属性 | 英文 | 描述
:--|:--|:--
账号
名称
描述
手机号
邮箱
所属企业
状态 | status

![图片](./img/ph017.png)

## 1.6 可视化管理

基于组态软件和规则引擎，可定制业务的可视化界面功能。

### 1.6.1 Scada大屏

#### 1.6.1.1 编辑

基于第三方企业版开源代码，类似[语雀](http://topology.le5le.com/workspace)、[mxgraph](https://github.com/jgraph/mxgraph)，实现Scada实时监控功能。

语雀企业版已实现基础功能，需要开发集成《规则引擎》。

![图片](./img/topology.le5le.com.png)

#### 1.6.1.2 绑定

（通过配置json，可以实现不同位置不同样式不同数据的展示。）-- 张涛


### 1.6.2 监控可视化界面

企业通过拖拽相关组件来实现自定义数据可视化界面，用于运维投屏等场景。

![图片](./img/ph010.png)

## 1.7 用能检测

沿用现有箱变项目和长宁一期项目。

### 1.7.1 实时检测

![图片](./img/ph030.png)

### 1.7.2 曲线分析

![图片](./img/ph031.png)

### 1.7.3 抄表统计

![图片](./img/ph032.png)

## 1.8 通知管理

配置用于管理各种通知的配置，及时通过短信、邮件通知给运维人员。

## 1.9 日志管理

![图片](./img/ph016.png)

+ 平台用户: 操作
+ 物联网关: 登陆，激活记录、上传数据量统计（每10分钟统计）
+ 激活物联网关: 修改物模型、在线离线、不发生数据

数据库设计表：

+ 《用户操作日志表》
+ 《物联网关操作日志表》
+ 《物联网关上传数据表》

<s>
1. 记录设备行为、上行消息、下行消息等消息内容，点击详情内容可查看具体日志的详细内容。
2. 记录IoT服务器各种服务日志等，点击详情内容可查看具体日志的详细内容。
3. 记录数据异常日志、定制debug日志等。
</s>

### 1.9.1 系统日志

读取各个服务的.log文件进行推送  
读取不同的日志文件，增加分类字段，最终保存到不同的索引中。  
比如：nginx访问日志，mysql错误日志，mysql慢查询日志  
网络 、传感器、物联网关、服务  
服务器相关命名方式 ：nginx-access-20200101；

### 1.9.2 业务日志

业务日志分为两类：行为日志、错误日志

各个应用将业务日志输出到Redis队列中，最终保存到日志系统；
因为考虑的是，不同业务产生的日志，对应唯一队列，所以没有增加分类字段

**业务日志内容输出时，指定日志格式，指定字段存储筛选条件**  
配置logstash过滤规则，将信息拆分，在kibana对应筛选过滤；

比如 ：iot业务行为日志，Redis队列写入的内容字符串为；  
“2021-01-01 12:12:12|用户模块|登录操作|操作人|日志描述xxx”  
“2021-01-01 12:12:12|组织台账|操作|操作人|日志描述xxx”  
“2021-01-01 12:12:12|IOT用能监测|浏览操作|操作人|日志描述xxx”  

#### 行为日志

日志名称测试 ： System_Behavior_Log_Date
例如 iot_login_Log_20200101;
日志内容格式 ： `xxxx | xxxxx | xxxxx | xxxxx | xxxx`

字段 | 描述
:- | :-
时间 | 日志创建时间 ： 2021-01-01 12:12:12
业务 | 系统对应业务 ：登录、修改信息
操作人 | 对应系统业务： IOT对应用户id、平台对应物联网关等
操作描述 | 本次操作描述：简短描述操作，方便查看
操作参数 | json格式参数：将对应参数以json格式写入Redis

#### 错误日志

日志名称测试 ： System_Error_Log_Date  
例如: App_Error_Log_20200101  
日志内容格式 ： `xxxx | xxxxx | xxxxx | xxxxx | xxxx`

字段 | 描述
:- | :-
时间 | 日志创建时间 ： 2020-01-01 12:12:12
系统 | 日志产生系统 ： 盒子、iot平台等
业务 | iot系统对应业务 ：登录、绑定电器设备、修改信息等
错误类型（未确定）| 错误类型标识： Notice、Error
错误地址 | 发生错误地址：xxx.com/xxx/xxx
错误文件 | 发生错误文件：文件名及行数
错误参数 | 发生错误参数：将对应参数以json格式写入Redis
错误描述 | 本次操作描述：简短描述操作，方便查看

## 1.10 数据处理

### 冻结数据

#### 超表

表名：电气设备类编码  
标签：tags（物联网关ID，企业ID）（表字段）

名称 | 字段编码 | 字段类型 |说明
:-|:-|:-|:-
时间戳| ts | timestamp
物联网关ID | gatewayId|
企业ID | productId| |通过企业授权码productKey获取
具体属性字段 （根据相应类型的电气设备来单独建表）
如：A相电流| aPhsa|


#### 子表

子表是根据超表来生成的相应电气设备的相应表（与超表表结构一致）

表名：电气设备类编码  
标签：tags（物联网关ID，企业ID）（表字段）

名称 | 字段编码 | 字段类型 |说明
:-|:-|:-|:-
时间戳| ts | timestamp
物联网关ID | gatewayId|
企业ID | productId| |通过企业授权码productKey获取
具体属性字段 （根据相应类型的电气设备来单独建表）
如：A相电流| aPhsa|

例如：A企业授权码ID是13
物联网关ID是 10
电气设备是电表
电气设备类型码 ammeter
电气设备ID是8 

则
## 1.11 NTP服务

保证物联网关和服务器的时间一致。优先度如下：

1. **北斗**
2. GPS
3. NTP
4. RTC

## 1.12 数据备份、容灾等

## 1.12 非功能需求
